<div *ngIf="stay as currentStay; else loadingTpl" class="space-y-4">
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div>
      <a routerLink="/reservations" class="text-xs font-semibold uppercase text-accent">Back to reservations</a>
      <h2 class="mt-1 text-2xl font-bold">Stay {{ currentStay.id }}</h2>
    </div>

    <div class="flex gap-2" *ngIf="folio as currentFolio">
      <button class="rounded-lg border border-slate-300 px-4 py-2 text-sm" (click)="openChargeModal()" [disabled]="currentFolio.status !== 1">Add charge</button>
      <button class="rounded-lg border border-slate-300 px-4 py-2 text-sm" (click)="openPaymentModal()" [disabled]="currentFolio.status !== 1">Add payment</button>
      <button class="rounded-lg bg-accent px-4 py-2 text-sm font-semibold text-white" (click)="openCheckOutModal()" [disabled]="currentStay.status !== 1">Check-out</button>
    </div>
  </div>

  <div class="grid gap-4 md:grid-cols-3">
    <article class="rounded-xl bg-panel p-4 shadow-card">
      <p class="text-xs uppercase text-muted">Stay status</p>
      <p class="mt-1 text-sm font-semibold">{{ currentStay.status === 1 ? 'CheckedIn' : currentStay.status === 2 ? 'CheckedOut' : 'Cancelled' }}</p>
      <p class="mt-3 text-xs uppercase text-muted">Check-in</p>
      <p class="mt-1 text-sm">{{ currentStay.checkInAt | date : 'medium' }}</p>
      <p class="mt-3 text-xs uppercase text-muted">Check-out</p>
      <p class="mt-1 text-sm">{{ currentStay.checkOutAt ? (currentStay.checkOutAt | date : 'medium') : '-' }}</p>
    </article>

    <article class="rounded-xl bg-panel p-4 shadow-card md:col-span-2" *ngIf="folio as currentFolio; else noFolioTpl">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs uppercase text-muted">Folio</p>
          <p class="mt-1 text-sm font-semibold">{{ currentFolio.id }}</p>
        </div>
        <span class="rounded-full bg-slate-900 px-3 py-1 text-xs font-semibold text-white">{{ statusLabel(currentFolio.status) }}</span>
      </div>

      <div class="mt-4 grid gap-3 md:grid-cols-3">
        <div class="rounded-lg border border-slate-200 p-3">
          <p class="text-xs uppercase text-muted">Charges</p>
          <p class="mt-1 text-lg font-semibold">{{ currentFolio.chargesTotal | number : '1.2-2' }}</p>
        </div>
        <div class="rounded-lg border border-slate-200 p-3">
          <p class="text-xs uppercase text-muted">Payments</p>
          <p class="mt-1 text-lg font-semibold">{{ currentFolio.paymentsTotal | number : '1.2-2' }}</p>
        </div>
        <div class="rounded-lg border border-slate-200 p-3">
          <p class="text-xs uppercase text-muted">Balance</p>
          <p class="mt-1 text-lg font-semibold" [class.text-danger]="currentFolio.balance !== 0">{{ currentFolio.balance | number : '1.2-2' }}</p>
        </div>
      </div>
    </article>
  </div>

  <div class="grid gap-4 lg:grid-cols-2" *ngIf="folio as currentFolio">
    <section class="rounded-xl bg-panel p-4 shadow-card">
      <h3 class="text-lg font-semibold">Charges</h3>
      <div class="mt-3 space-y-3" *ngIf="currentFolio.charges.length; else emptyChargesTpl">
        <article class="rounded-lg border border-slate-200 p-3" *ngFor="let charge of currentFolio.charges">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-sm font-semibold">{{ charge.description }}</p>
              <p class="text-xs text-muted">{{ chargeSourceLabel(charge.source) }} · {{ charge.createdAt | date : 'short' }}</p>
            </div>
            <p class="text-sm font-bold">{{ charge.total | number : '1.2-2' }}</p>
          </div>
        </article>
      </div>
    </section>

    <section class="rounded-xl bg-panel p-4 shadow-card">
      <h3 class="text-lg font-semibold">Payments</h3>
      <div class="mt-3 space-y-3" *ngIf="currentFolio.payments.length; else emptyPaymentsTpl">
        <article class="rounded-lg border border-slate-200 p-3" *ngFor="let payment of currentFolio.payments">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-sm font-semibold">{{ paymentMethodLabel(payment.method) }}</p>
              <p class="text-xs text-muted">{{ payment.reference || 'No reference' }} · {{ payment.paidAt | date : 'short' }}</p>
            </div>
            <p class="text-sm font-bold">{{ payment.amount | number : '1.2-2' }}</p>
          </div>
        </article>
      </div>
    </section>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="rounded-xl bg-panel p-4 shadow-card">Loading stay...</div>
</ng-template>

<ng-template #noFolioTpl>
  <article class="rounded-xl bg-panel p-4 shadow-card md:col-span-2">
    No folio available for this stay.
  </article>
</ng-template>

<ng-template #emptyChargesTpl>
  <p class="mt-3 text-sm text-muted">No charges yet.</p>
</ng-template>

<ng-template #emptyPaymentsTpl>
  <p class="mt-3 text-sm text-muted">No payments yet.</p>
</ng-template>

<app-modal [open]="chargeModalOpen" title="Add consumption charge" (close)="chargeModalOpen = false">
  <form class="space-y-3" [formGroup]="chargeForm" (ngSubmit)="submitCharge()">
    <div class="grid gap-3 md:grid-cols-2">
      <app-form-field label="Source">
        <select class="w-full rounded-lg border border-slate-300 px-3 py-2" formControlName="source">
          <option *ngFor="let source of chargeSourceOptions" [value]="source.value">{{ source.label }}</option>
        </select>
      </app-form-field>

      <app-form-field label="Location (stock)">
        <select class="w-full rounded-lg border border-slate-300 px-3 py-2" formControlName="locationId">
          <option value="">No location</option>
          <option *ngFor="let location of locations" [value]="location.id">{{ location.name }}</option>
        </select>
      </app-form-field>
    </div>

    <app-form-field label="Description">
      <input class="w-full rounded-lg border border-slate-300 px-3 py-2" formControlName="description" />
    </app-form-field>

    <label class="flex items-center gap-2 text-sm text-slate-700">
      <input type="checkbox" formControlName="allowOverridePrice" />
      Allow override item price
    </label>

    <div formArrayName="items" class="space-y-3">
      <div *ngFor="let item of chargeItems.controls; let i = index" [formGroupName]="i" class="rounded-lg border border-slate-200 p-3">
        <div class="grid gap-2 md:grid-cols-3">
          <app-form-field label="Product">
            <select class="w-full rounded-lg border border-slate-300 px-3 py-2" formControlName="productId">
              <option value="">No product</option>
              <option *ngFor="let product of products" [value]="product.id">{{ product.name }}</option>
            </select>
          </app-form-field>

          <app-form-field label="Qty">
            <input type="number" step="0.001" class="w-full rounded-lg border border-slate-300 px-3 py-2" formControlName="qty" />
          </app-form-field>

          <app-form-field label="Unit price (optional)">
            <input type="number" step="0.01" class="w-full rounded-lg border border-slate-300 px-3 py-2" formControlName="unitPrice" />
          </app-form-field>
        </div>

        <div class="mt-2 text-right">
          <button type="button" class="rounded border border-red-300 px-2 py-1 text-xs text-red-700" (click)="removeChargeItem(i)">Remove</button>
        </div>
      </div>
    </div>

    <button type="button" class="rounded border border-slate-300 px-3 py-2 text-sm" (click)="addChargeItem()">Add item</button>

    <div class="flex justify-end gap-2 pt-2">
      <button type="button" class="rounded-md border border-slate-300 px-4 py-2 text-sm" (click)="chargeModalOpen = false">Cancel</button>
      <button type="submit" class="rounded-md bg-slate-900 px-4 py-2 text-sm font-semibold text-white" [disabled]="actionLoading">
        {{ actionLoading ? 'Saving...' : 'Save charge' }}
      </button>
    </div>
  </form>
</app-modal>

<app-modal [open]="paymentModalOpen" title="Add payment" (close)="paymentModalOpen = false">
  <form class="space-y-3" [formGroup]="paymentForm" (ngSubmit)="submitPayment()">
    <div class="grid gap-3 md:grid-cols-2">
      <app-form-field label="Amount">
        <input type="number" step="0.01" class="w-full rounded-lg border border-slate-300 px-3 py-2" formControlName="amount" />
      </app-form-field>

      <app-form-field label="Method">
        <select class="w-full rounded-lg border border-slate-300 px-3 py-2" formControlName="method">
          <option *ngFor="let method of paymentMethodOptions" [value]="method.value">{{ method.label }}</option>
        </select>
      </app-form-field>
    </div>

    <app-form-field label="Reference">
      <input class="w-full rounded-lg border border-slate-300 px-3 py-2" formControlName="reference" />
    </app-form-field>

    <div class="flex justify-end gap-2 pt-2">
      <button type="button" class="rounded-md border border-slate-300 px-4 py-2 text-sm" (click)="paymentModalOpen = false">Cancel</button>
      <button type="submit" class="rounded-md bg-slate-900 px-4 py-2 text-sm font-semibold text-white" [disabled]="actionLoading">
        {{ actionLoading ? 'Saving...' : 'Save payment' }}
      </button>
    </div>
  </form>
</app-modal>

<app-modal [open]="checkOutModalOpen" title="Check-out" (close)="checkOutModalOpen = false">
  <form class="space-y-3" [formGroup]="checkOutForm" (ngSubmit)="submitCheckOut()">
    <label class="flex items-center gap-2 text-sm text-slate-700">
      <input type="checkbox" formControlName="force" />
      Force check-out (allow pending balance)
    </label>

    <p class="text-sm text-muted">If folio has pending balance and force is disabled, backend returns 409.</p>

    <div class="flex justify-end gap-2 pt-2">
      <button type="button" class="rounded-md border border-slate-300 px-4 py-2 text-sm" (click)="checkOutModalOpen = false">Cancel</button>
      <button type="submit" class="rounded-md bg-accent px-4 py-2 text-sm font-semibold text-white" [disabled]="actionLoading">
        {{ actionLoading ? 'Processing...' : 'Confirm check-out' }}
      </button>
    </div>
  </form>
</app-modal>
